# Notion Sync Integration

This document describes how to wire the agent repository to a Notion workspace so that automation can synchronize content without exposing credentials in the codebase. The pattern mirrors [`spec-bootstrap`](https://github.com/PR-CYBR/spec-bootstrap) and relies on Terraform Cloud (TFC) to broker secrets into GitHub Actions.

## Required repository secrets

| Secret | Purpose | Notes |
| ------ | ------- | ----- |
| `NOTION_TOKEN` | Internal integration token used by the Notion API. | Generated by the Notion integration and never checked into source control. |
| `NOTION_DATABASE_ID` | Target database to read/write updates. | Share the database with the integration after creation. |
| `NOTION_PARENT_PAGE_ID` | Parent page that owns the synced database or pages. | Optional if you only interact with a database, required when creating new pages. |

The GitHub repository must also keep the existing `AGENT_ACTIONS` personal access token (PAT) for automation. Scope it to the minimal permissions required for CI/CD (repository contents read/write, workflow) and avoid granting organization-wide access.

## How Terraform Cloud populates the secrets

Terraform Cloud holds the canonical values as workspace variables:

1. Create (or update) the following Terraform workspace environment variables: `NOTION_TOKEN`, `NOTION_DATABASE_ID`, and `NOTION_PARENT_PAGE_ID`. Mark them as **sensitive** so that Terraform Cloud hides their values.
2. Add matching variable declarations to `agent-variables.tf` (see below). Terraform code in the `spec-bootstrap` pattern reads these variables and pushes them into GitHub Actions secrets using the Terraform Cloud/GitHub provider bindings.
3. Apply the Terraform workspace. Terraform Cloud will provision or update the secrets in this repository without storing them in git.

Because Terraform manages the lifecycle, never edit these GitHub secrets manuallyâ€”treat Terraform Cloud as the source of truth.

## Notion integration scopes

Create a [Notion internal integration](https://developers.notion.com/docs/create-a-notion-integration) with **only** the following capabilities:

- `Read content`
- `Insert content`
- `Update content`
- `Read comments` (only if the automation needs comment metadata)

Avoid the `Manage users` and `Manage workspace` scopes; they exceed the needs of this sync. Share the specific database (and parent page if applicable) with the integration so it cannot access unrelated workspace data.

## GitHub Actions workflow expectations

The `.github/workflows/notion-sync.yml` workflow consumes these secrets. It pulls them in via `${{ secrets.NOTION_TOKEN }}` (and the related IDs) and runs with `contents: read` permissions so the automation token follows the principle of least privilege. See the workflow file for comments on how secrets are injected into runtime environment variables.

## Local development

To test locally without leaking credentials:

1. Copy `config/notion.yml` to `config/notion.local.yml` and change the environment variable names if desired.
2. Export the environment variables in your shell (e.g., `export NOTION_TOKEN="..."`).
3. Run `python -m src.agent_logic.notion_sync` to confirm the loader can read the configuration. The script validates the presence of each secret but never echoes the sensitive values.

Following these steps keeps sensitive information outside the repository while preserving parity between local development and the CI/CD pipeline.
